services:
  app:
    build:
      context: .. # Project root directory
      dockerfile: ./docker/app/Dockerfile
    ports:
      - "8000:8000" # Expose app port to host for potential manual inspection
    volumes:
      # Mount source code for live reload
      - ../src:/app/src
      - ../static:/app/static
      - ../templates:/app/templates
      - ../pyproject.toml:/app/pyproject.toml
    # Command to run the application, ensuring it listens on all interfaces
    # and uses the standard port 8000.
    command: uvicorn src.food_diary.main:app --host 0.0.0.0 --port 8000
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 1s
      timeout: 1s
      retries: 5
      start_period: 1s
    networks:
      - test_network

  playwright-tests:
    build:
      context: .. # Project root directory
      dockerfile: ./docker/playwright/Dockerfile
    depends_on:
      app:
        condition: service_healthy # Wait for app to be healthy
    environment:
      # BASE_URL is set in tests/e2e/test_app.py to http://app:8000
      CI: "true" # Often useful for Playwright tests
    networks:
      - test_network
    # The CMD in docker/playwright/Dockerfile is ["pytest", "tests/e2e"]

networks:
  test_network:
    driver: bridge
