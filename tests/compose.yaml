services:
  app:
    build:
      context: .. # Project root directory
      dockerfile: ./docker/app/Dockerfile
    volumes:
      # Mount source code for live reload
      - ../src:/app/src
      - ../static:/app/static
      - ../templates:/app/templates
      - ../pyproject.toml:/app/pyproject.toml
    # Command to run the application, ensuring it listens on all interfaces
    # and uses the standard port 8000.
    command: uvicorn src.food_diary.main:app --host 0.0.0.0 --port 8000 --log-level error
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 1s
      timeout: 1s
      retries: 5
      start_period: 1s
    networks:
      - test_network

  nginx:
    build:
      context: ..
      dockerfile: ./docker/nginx/Dockerfile
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ../nginx/nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      app:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-k", "-f", "https://localhost/"]
      interval: 1s
      timeout: 1s
      retries: 5
      start_period: 1s
    networks:
      - test_network

  tests:
    build:
      context: ..
      dockerfile: ./docker/playwright/Dockerfile
    depends_on:
      nginx:
        condition: service_healthy
    networks:
      - test_network
    volumes:
      - ../tests:/tests
    working_dir: /tests
    environment:
      - BASE_URL=https://nginx
    platform: linux/amd64 # Force compatibility
    command: ["pytest", "e2e/", "-v"]

networks:
  test_network:
    driver: bridge
