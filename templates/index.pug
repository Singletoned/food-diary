doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1.0")
    title Food Diary Entry
    link(rel="stylesheet", href="/static/styles.css")
    script(
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js",
      defer
    )
    script(src="/static/app.js", defer)
  body(x-data="foodDiaryApp()", x-init="initApp()")
    h1 Food Diary Entry

    div(class="food-diary-form")
      div(class="form-group")
        label(for="note", class="form-label") Note:
        textarea#note(
          x-model="note",
          rows="4",
          class="form-textarea",
          placeholder="Enter your food notes..."
        )

      div(class="form-group")
        label(for="photo", class="form-label") Photo:
        input#photo(
          type="file",
          accept="image/*",
          @change="handlePhotoUpload($event)",
          class="form-file-input"
        )

      div(x-show="photoPreview", class="form-group")
        h3 Photo Preview:
        img(
          :src="photoPreview",
          alt="Photo preview",
          class="photo-preview"
        )

      button(
        @click="saveEntry",
        :disabled="!note && !photoBase64",
        class="save-button"
      ) Save Entry

    //- You can link to static JS files here, e.g.:
    //- script(src="/static/script.js")

    script.
      function foodDiaryApp() {
        return {
          note: "",
          photoBase64: null,
          photoPreview: null,

          async initApp() {
            try {
              await foodDiaryUtils.initDB(); // This calls initDB from static/app.js
              console.log("Alpine component initialized, DB connection ready via static/app.js.");
            } catch (error) {
              console.error("Alpine component: Failed to initialize DB via static/app.js:", error);
              alert("Database initialization failed. App may not function correctly.");
            }
          },

          handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (e) => {
                this.photoBase64 = e.target.result;
                this.photoPreview = e.target.result;
              };
              reader.onerror = (e) => {
                console.error("FileReader error:", e);
                alert("Error reading file.");
                this.photoBase64 = null;
                this.photoPreview = null;
              };
              reader.readAsDataURL(file);
            } else {
              this.photoBase64 = null;
              this.photoPreview = null;
            }
          },

          async saveEntry() {
            if (!this.note && !this.photoBase64) {
              alert("Please enter a note or select a photo to save.");
              return;
            }

            const entryData = {
              timestamp: new Date().toISOString(),
              text: this.note,
              photo: this.photoBase64,
            };

            try {
              const newEntryId = await foodDiaryUtils.saveEntryToDB(entryData); // Calls saveEntryToDB from static/app.js
              console.log("Alpine component: Entry saved successfully with ID:", newEntryId);
              alert("Entry saved!");
              this.note = "";
              this.photoBase64 = null;
              this.photoPreview = null;
              // Reset file input
              const photoInput = document.getElementById("photo");
              if (photoInput) {
                photoInput.value = null;
              }
            } catch (error) {
              console.error("Alpine component: Error saving entry via static/app.js:", error);
              alert("Error saving entry. Check console for details.");
            }
          },
          // Functions to use readAllEntriesFromDB or markEntryAsSyncedInDB can be added here
          // when UI elements for those actions are implemented. For example:
          /*
          async loadAllEntries() {
            try {
              const entries = await foodDiaryUtils.readAllEntriesFromDB();
              // Process entries, e.g., display them
              console.log("Loaded entries:", entries);
            } catch (error) {
              console.error("Alpine: Error loading entries", error);
            }
          },
          async markEntrySynced(entryId) {
            try {
              await foodDiaryUtils.markEntryAsSyncedInDB(entryId);
              console.log(`Alpine: Marked entry ${entryId} as synced`);
              // Update UI accordingly
            } catch (error) {
              console.error(`Alpine: Error marking entry ${entryId} as synced`, error);
            }
          }
          */
        };
      }
