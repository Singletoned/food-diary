doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1.0, viewport-fit=cover")
    title Chompix - Smart Food Diary
    meta(name="description", content="Track your food diary with photos and notes, works offline")

    //- PWA Manifest
    link(rel="manifest", href="#{api_stage_path}/static/manifest.json")

    //- iOS-specific meta tags
    meta(name="apple-mobile-web-app-capable", content="yes")
    meta(name="apple-mobile-web-app-status-bar-style", content="default")
    meta(name="apple-mobile-web-app-title", content="Chompix")

    //- iOS app icons
    link(rel="apple-touch-icon", href="#{api_stage_path}/static/icons/icon-152x152.png", sizes="152x152")
    link(rel="apple-touch-icon", href="#{api_stage_path}/static/icons/icon-180x180.png", sizes="180x180")

    //- Theme color for browser UI
    meta(name="theme-color", content="#00d1b2")

    //- Stylesheets
    link(
      rel="stylesheet",
      href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css"
    )
    link(rel="stylesheet", href="#{api_stage_path}/static/styles.css")

    //- Scripts
    script(
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js",
      defer
    )
    script(
      src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"
    )
    script(src="#{api_stage_path}/static/app.js")
  body(x-data="foodDiaryApp()", x-init="initApp()")
    // Login page for unauthenticated users
    section.hero.is-fullheight(x-show="!isAuthenticated")
      .hero-body
        .container.has-text-centered
          .column.is-4.is-offset-4
            .box
              h1.title.is-2 ðŸ½ï¸ Chompix
              p.subtitle Track your meals with photos and notes
              p.subtitle(style="margin-top: 8px; font-size: 0.95rem;") Sign in to get started
              button.button.is-primary.is-large.is-fullwidth(
                @click="login",
                style="margin-top: 24px;"
              )
                span.icon
                  | ðŸ”
                span Sign in with GitHub

    // Main app for authenticated users
    div(x-show="isAuthenticated")
      nav.navbar.is-dark(role="navigation")
        .container
          .navbar-brand
            .navbar-item
              h1.title.is-4.has-text-white Chompix
          .navbar-menu
            .navbar-start
            .navbar-end
              .navbar-item
                .buttons
                  button.button.is-light.is-small(
                    @click="syncWithServer",
                    :disabled="syncStatus === 'syncing'",
                    :title="syncStatus === 'idle' ? 'Sync with server' : syncStatus === 'syncing' ? 'Syncing...' : 'Sync error (will retry)'"
                  )
                    span.icon.is-small
                      span(x-show="syncStatus === 'idle'") ðŸ”„
                      span(x-show="syncStatus === 'syncing'") â³
                      span(x-show="syncStatus === 'error'") âš ï¸
                  button.button.is-light.is-small(
                    @click="exportData",
                    :disabled="entries.length === 0",
                    title="Export data"
                  )
                    span.icon.is-small
                      | ðŸ“¦
                  .tag.is-light(:class="navigator.onLine ? 'is-success' : 'is-warning'")
                    span(x-show="navigator.onLine") ðŸŸ¢
                    span(x-show="!navigator.onLine") ðŸ”´
              .navbar-item.has-dropdown.is-hoverable
                a.navbar-link.has-text-white
                  figure.image.is-24x24.mr-2(x-show="userInfo?.avatar_url")
                    img.is-rounded(
                      :src="userInfo?.avatar_url",
                      :alt="userInfo?.username"
                    )
                  span(x-text="userInfo?.name || userInfo?.username")
                .navbar-dropdown.is-right
                  a.navbar-item(@click="logout") Logout

      .container
        .section.py-4
          .tabs.is-centered.is-boxed
            ul
              li(:class="{ 'is-active': currentView === 'entry' }")
                a(@click="currentView = 'entry'")
                  span.icon.is-small
                    | âœï¸
                  span New Entry
              li(:class="{ 'is-active': currentView === 'history' }")
                a(@click="currentView = 'history'")
                  span.icon.is-small
                    | ðŸ“š
                  span History

        .section(x-show="currentView === 'entry'")
          .columns.is-centered
            .column.is-8
              .box
                h2.title.is-4 ðŸ“ Add New Entry
                .field
                  label.label(for="note") What did you eat?
                  .control
                    textarea#note.textarea(
                      x-model="note",
                      rows="4",
                      placeholder="Describe your meal..."
                    )

                .field
                  label.label(for="photo") Add a Photo
                  .file.is-boxed
                    label.file-label
                      input#photo.file-input(
                        type="file",
                        accept="image/*",
                        @change="handlePhotoUpload($event)"
                      )
                      span.file-cta
                        span.file-icon
                          | ðŸ“·
                        span.file-label Tap to choose photo

                .field(x-show="photoPreview")
                  .control
                    figure.image.is-256x256
                      img(:src="photoPreview", alt="Photo preview")

                .field
                  .control
                    label.checkbox
                      input#custom-datetime-checkbox(
                        type="checkbox",
                        x-model="useCustomDatetime"
                      )
                      |
                      | Set custom date/time

                  .field(x-show="useCustomDatetime", style="margin-top: 12px;")
                    .control
                      input#event-datetime.input(
                        type="datetime-local",
                        x-model="eventDatetime"
                      )

                .field(style="margin-top: 24px;")
                  .control
                    button.button.is-success.is-large.is-fullwidth(
                      @click="saveEntry",
                      :disabled="!note && !photoBase64"
                    )
                      span.icon
                        | âœ“
                      span Save Entry

        .section(x-show="currentView === 'history'")
          .columns.is-centered
            .column.is-8
              h2.title.is-4(style="margin-bottom: 20px;") ðŸ“š Your Food Diary
              .columns.is-multiline
                template(x-for="entry in entries", :key="entry.id")
                  .column.is-12
                    .card
                      .card-image(x-show="entry.photo")
                        figure.image
                          img(:src="entry.photo", alt="Food photo")
                      .card-content
                        .card-header-title(style="padding: 0; margin-bottom: 12px;")
                          span.icon.mr-2
                            | ðŸ“…
                          span(x-text="formatTimestamp(entry.event_datetime)")
                          button.delete.is-small(
                            @click="deleteEntry(entry.id)",
                            style="margin-left: auto;"
                          )
                        .content(x-show="entry.text")
                          p(x-text="entry.text")
              .notification.is-info.has-text-centered(
                x-show="entries.length === 0"
              )
                span.icon.is-large
                  | ðŸ“
                p.is-size-5(style="margin-top: 12px;") No entries yet. Start tracking your meals!

    //- You can link to static JS files here, e.g.:
    //- script(src="/static/script.js")

    //- Service Worker Registration
    script.
      // Register service worker for PWA functionality
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker
            .register('#{api_stage_path}/service-worker.js')
            .then((registration) => {
              console.log('Service Worker registered successfully:', registration.scope);

              // Check for updates periodically
              setInterval(() => {
                registration.update();
              }, 60000); // Check every minute
            })
            .catch((error) => {
              console.error('Service Worker registration failed:', error);
            });
        });
      }

    script.
      function foodDiaryApp() {
        return {
          currentView: "entry",
          note: "",
          useCustomDatetime: false,
          eventDatetime: "",
          photoBase64: null,
          photoPreview: null,
          entries: [],
          syncStatus: "idle", // idle, syncing, error
          isAuthenticated: #{ is_authenticated },
          userInfo: #{ user },
          apiStagePath: #{ api_stage_path },

          async initApp() {
            if (!this.isAuthenticated) {
              return; // Don't initialize app data if not authenticated
            }
            try {
              await foodDiaryUtils.initDB(); // This calls initDB from static/app.js
              await this.loadEntries(); // Load existing entries
              await this.syncWithServer(); // Initial sync
              console.log("Alpine component initialized, DB connection ready via static/app.js.");
            } catch (error) {
              console.error("Alpine component: Failed to initialize DB via static/app.js:", error);
              alert("Database initialization failed. App may not function correctly.");
            }
          },

          async syncWithServer() {
            if (this.syncStatus === "syncing") return; // Prevent concurrent syncs

            this.syncStatus = "syncing";
            try {
              await foodDiaryUtils.syncWithServer();
              await this.loadEntries(); // Refresh entries after sync
              this.syncStatus = "idle";
            } catch (error) {
              console.error("Sync failed:", error);
              this.syncStatus = "error";
              // Reset error status after 3 seconds so it doesn't stay permanently
              setTimeout(() => {
                if (this.syncStatus === "error") {
                  this.syncStatus = "idle";
                }
              }, 3000);
            }
          },

          async loadEntries() {
            try {
              this.entries = await foodDiaryUtils.readAllEntriesFromDB();
              console.log("DEBUG: Loaded entries from DB:", this.entries);
              console.log("DEBUG: Number of entries:", this.entries.length);
              // Sort by event_datetime, newest first
              this.entries.sort((a, b) => new Date(b.event_datetime) - new Date(a.event_datetime));
              console.log("DEBUG: After sorting:", this.entries);
            } catch (error) {
              console.error("Error loading entries:", error);
            }
          },

          formatTimestamp(eventDatetime) {
            const date = new Date(eventDatetime);
            return date.toLocaleDateString() + " " + date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
          },

          async deleteEntry(entryId) {
            if (!confirm("Are you sure you want to delete this entry?")) {
              return;
            }
            try {
              // Delete from local database
              await foodDiaryUtils.deleteEntryFromDB(entryId);
              // Also try to delete from server
              await foodDiaryUtils.deleteEntryOnServer(entryId);
              await this.loadEntries(); // Refresh the list
            } catch (error) {
              console.error("Error deleting entry:", error);
              alert("Error deleting entry. Check console for details.");
            }
          },

          handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (e) => {
                this.photoBase64 = e.target.result;
                this.photoPreview = e.target.result;
              };
              reader.onerror = (e) => {
                console.error("FileReader error:", e);
                alert("Error reading file.");
                this.photoBase64 = null;
                this.photoPreview = null;
              };
              reader.readAsDataURL(file);
            } else {
              this.photoBase64 = null;
              this.photoPreview = null;
            }
          },

          async saveEntry() {
            if (!this.note && !this.photoBase64) {
              alert("Please enter a note or select a photo to save.");
              return;
            }

            const entryData = {
              timestamp: new Date().toISOString(),
              event_datetime: this.useCustomDatetime && this.eventDatetime ? new Date(this.eventDatetime).toISOString() : new Date().toISOString(),
              text: this.note,
              photo: this.photoBase64,
            };

            try {
              const newEntryId = await foodDiaryUtils.saveEntryToDB(entryData); // Calls saveEntryToDB from static/app.js
              console.log("Alpine component: Entry saved successfully with ID:", newEntryId);
              alert(`Entry saved! Data: ${JSON.stringify({ text: this.note, photo: this.photoBase64 ? "has photo" : "no photo", event_datetime: entryData.event_datetime })}`);
              this.note = "";
              this.useCustomDatetime = false;
              this.eventDatetime = "";
              this.photoBase64 = null;
              this.photoPreview = null;
              // Reset file input
              const photoInput = document.getElementById("photo");
              if (photoInput) {
                photoInput.value = null;
              }
              // Refresh entries list and switch to history view
              await this.loadEntries();
              this.currentView = "history";
            } catch (error) {
              console.error("Alpine component: Error saving entry via static/app.js:", error);
              alert("Error saving entry. Check console for details.");
            }
          },

          async exportData() {
            try {
              const zip = new JSZip();

              // Create JSON data without photos for the main export
              const exportEntries = this.entries.map((entry) => ({
                id: entry.id,
                timestamp: entry.timestamp,
                event_datetime: entry.event_datetime,
                text: entry.text,
                hasPhoto: !!entry.photo,
                synced: entry.synced,
              }));

              // Add JSON file
              zip.file("entries.json", JSON.stringify(exportEntries, null, 2));

              // Add images folder and extract photos
              const imagesFolder = zip.folder("images");
              let imageCount = 0;

              for (const entry of this.entries) {
                if (entry.photo) {
                  // Extract base64 data and file extension
                  const matches = entry.photo.match(/^data:image\/([a-zA-Z]+);base64,(.+)$/);
                  if (matches) {
                    const extension = matches[1];
                    const base64Data = matches[2];
                    const fileName = `entry_${entry.id}_${entry.event_datetime.split("T")[0]}.${extension}`;
                    imagesFolder.file(fileName, base64Data, { base64: true });
                    imageCount++;
                  }
                }
              }

              // Generate and download zip
              const content = await zip.generateAsync({ type: "blob" });
              const url = window.URL.createObjectURL(content);
              const link = document.createElement("a");
              link.href = url;
              link.download = `food-diary-export-${new Date().toISOString().split("T")[0]}.zip`;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              window.URL.revokeObjectURL(url);

              alert(`Export complete! Downloaded ${this.entries.length} entries with ${imageCount} images.`);
            } catch (error) {
              console.error("Export failed:", error);
              alert("Export failed. Check console for details.");
            }
          },

          async login() {
            window.location.href = `${this.apiStagePath}/auth/login`;
          },

          async logout() {
            try {
              await fetch(`${this.apiStagePath}/auth/logout`, { method: "POST" });
              window.location.href = `${this.apiStagePath}/`;
            } catch (error) {
              console.error("Logout failed:", error);
              window.location.href = `${this.apiStagePath}/auth/logout`;
            }
          },

          // Functions to use readAllEntriesFromDB or markEntryAsSyncedInDB can be added here
          // when UI elements for those actions are implemented. For example:
          /*
          async loadAllEntries() {
            try {
              const entries = await foodDiaryUtils.readAllEntriesFromDB();
              // Process entries, e.g., display them
              console.log("Loaded entries:", entries);
            } catch (error) {
              console.error("Alpine: Error loading entries", error);
            }
          },
          async markEntrySynced(entryId) {
            try {
              await foodDiaryUtils.markEntryAsSyncedInDB(entryId);
              console.log(`Alpine: Marked entry ${entryId} as synced`);
              // Update UI accordingly
            } catch (error) {
              console.error(`Alpine: Error marking entry ${entryId} as synced`, error);
            }
          }
          */
        };
      }
