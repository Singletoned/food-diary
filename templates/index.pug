doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1.0")
    title Food Diary Entry
    link(rel="stylesheet", href="/static/styles.css")
    script(
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js",
      defer
    )
    script(src="/static/app.js")
  body(x-data="foodDiaryApp()", x-init="initApp()")
    header
      .header-top
        h1 Food Diary
        .sync-controls
          button.sync-button(@click="syncWithServer", :disabled="syncStatus === 'syncing'")
            span(x-show="syncStatus === 'idle'") ðŸ”„ Sync
            span(x-show="syncStatus === 'syncing'") â³ Syncing...
            span(x-show="syncStatus === 'error'") âŒ Sync Error
          .online-status(:class="{ offline: !navigator.onLine }")
            span(x-show="navigator.onLine") ðŸŸ¢ Online
            span(x-show="!navigator.onLine") ðŸ”´ Offline
      nav.nav-tabs
        button.nav-tab(:class="{ active: currentView === 'entry' }", @click="currentView = 'entry'") New Entry
        button.nav-tab(:class="{ active: currentView === 'history' }", @click="currentView = 'history'") History

    .view-container(x-show="currentView === 'entry'")
      h2 Add New Entry
      .food-diary-form
      .form-group
        label.form-label(for="note") Note:
        textarea#note.form-textarea(
          x-model="note",
          rows="4",
          placeholder="Enter your food notes..."
        )

      .form-group
        label.form-label(for="photo") Photo:
        input#photo.form-file-input(
          type="file",
          accept="image/*",
          @change="handlePhotoUpload($event)"
        )

      .form-group(x-show="photoPreview")
        h3 Photo Preview:
        img.photo-preview(:src="photoPreview", alt="Photo preview")

        button.save-button(@click="saveEntry", :disabled="!note && !photoBase64") Save Entry

    .view-container(x-show="currentView === 'history'")
      h2 Entry History
      .history-container
        .entry(x-for="entry in entries", :key="entry.id")
          .entry-header
            .entry-timestamp(x-text="formatTimestamp(entry.timestamp)")
            button.delete-button(@click="deleteEntry(entry.id)") Ã—
          .entry-content
            p.entry-text(x-show="entry.text", x-text="entry.text")
            .entry-photo(x-show="entry.photo")
              img(:src="entry.photo", alt="Food photo")
        .empty-history(x-show="entries.length === 0")
          p No entries yet. Add your first food diary entry!

    //- You can link to static JS files here, e.g.:
    //- script(src="/static/script.js")

    script.
      function foodDiaryApp() {
        return {
          currentView: "entry",
          note: "",
          photoBase64: null,
          photoPreview: null,
          entries: [],
          syncStatus: "idle", // idle, syncing, error

          async initApp() {
            try {
              await foodDiaryUtils.initDB(); // This calls initDB from static/app.js
              await this.loadEntries(); // Load existing entries
              await this.syncWithServer(); // Initial sync
              console.log("Alpine component initialized, DB connection ready via static/app.js.");
            } catch (error) {
              console.error("Alpine component: Failed to initialize DB via static/app.js:", error);
              alert("Database initialization failed. App may not function correctly.");
            }
          },

          async syncWithServer() {
            if (this.syncStatus === "syncing") return; // Prevent concurrent syncs
            
            this.syncStatus = "syncing";
            try {
              await foodDiaryUtils.syncWithServer();
              await this.loadEntries(); // Refresh entries after sync
              this.syncStatus = "idle";
            } catch (error) {
              console.error("Sync failed:", error);
              this.syncStatus = "error";
              // Don't show alert for sync errors - just log them
            }
          },

          async loadEntries() {
            try {
              this.entries = await foodDiaryUtils.readAllEntriesFromDB();
              // Sort by timestamp, newest first
              this.entries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            } catch (error) {
              console.error("Error loading entries:", error);
            }
          },

          formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString() + " " + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
          },

          async deleteEntry(entryId) {
            if (!confirm("Are you sure you want to delete this entry?")) {
              return;
            }
            try {
              // Delete from local database
              await foodDiaryUtils.deleteEntryFromDB(entryId);
              // Also try to delete from server
              await foodDiaryUtils.deleteEntryOnServer(entryId);
              await this.loadEntries(); // Refresh the list
            } catch (error) {
              console.error("Error deleting entry:", error);
              alert("Error deleting entry. Check console for details.");
            }
          },

          handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (e) => {
                this.photoBase64 = e.target.result;
                this.photoPreview = e.target.result;
              };
              reader.onerror = (e) => {
                console.error("FileReader error:", e);
                alert("Error reading file.");
                this.photoBase64 = null;
                this.photoPreview = null;
              };
              reader.readAsDataURL(file);
            } else {
              this.photoBase64 = null;
              this.photoPreview = null;
            }
          },

          async saveEntry() {
            if (!this.note && !this.photoBase64) {
              alert("Please enter a note or select a photo to save.");
              return;
            }

            const entryData = {
              timestamp: new Date().toISOString(),
              text: this.note,
              photo: this.photoBase64,
            };

            try {
              const newEntryId = await foodDiaryUtils.saveEntryToDB(entryData); // Calls saveEntryToDB from static/app.js
              console.log("Alpine component: Entry saved successfully with ID:", newEntryId);
              alert("Entry saved!");
              this.note = "";
              this.photoBase64 = null;
              this.photoPreview = null;
              // Reset file input
              const photoInput = document.getElementById("photo");
              if (photoInput) {
                photoInput.value = null;
              }
              // Refresh entries list and switch to history view
              await this.loadEntries();
              this.currentView = "history";
            } catch (error) {
              console.error("Alpine component: Error saving entry via static/app.js:", error);
              alert("Error saving entry. Check console for details.");
            }
          },
          // Functions to use readAllEntriesFromDB or markEntryAsSyncedInDB can be added here
          // when UI elements for those actions are implemented. For example:
          /*
          async loadAllEntries() {
            try {
              const entries = await foodDiaryUtils.readAllEntriesFromDB();
              // Process entries, e.g., display them
              console.log("Loaded entries:", entries);
            } catch (error) {
              console.error("Alpine: Error loading entries", error);
            }
          },
          async markEntrySynced(entryId) {
            try {
              await foodDiaryUtils.markEntryAsSyncedInDB(entryId);
              console.log(`Alpine: Marked entry ${entryId} as synced`);
              // Update UI accordingly
            } catch (error) {
              console.error(`Alpine: Error marking entry ${entryId} as synced`, error);
            }
          }
          */
        };
      }
