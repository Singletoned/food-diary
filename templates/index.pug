doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1.0")
    title Food Diary Entry
    //- You can link to static CSS files here, e.g.:
    //- link(rel="stylesheet", href="/static/style.css")
    script(src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer)
    script(src="/static/app.js" defer)
  body(x-data="foodDiaryApp()" x-init="initApp()")
    h1 Food Diary Entry

    div(style="margin-bottom: 1rem;")
      label(for="note" style="display: block; margin-bottom: 0.25rem;") Note:
      textarea#note(x-model="note" rows="4" style="width: 100%; max-width: 500px; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;" placeholder="Enter your food notes...")

    div(style="margin-bottom: 1rem;")
      label(for="photo" style="display: block; margin-bottom: 0.25rem;") Photo:
      input#photo(type="file" accept="image/*" @change="handlePhotoUpload($event)" style="padding: 0.5rem;")

    div(x-show="photoPreview" style="margin-bottom: 1rem;")
      h3 Photo Preview:
      img(:src="photoPreview" alt="Photo preview" style="max-width: 300px; max-height: 300px; border: 1px solid #eee;")

    button(@click="saveEntry" :disabled="!note && !photoBase64" style="padding: 0.75rem 1.5rem; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;") Save Entry
    
    //- You can link to static JS files here, e.g.:
    //- script(src="/static/script.js")

    script.
      function foodDiaryApp() {
        return {
          note: '',
          photoBase64: null,
          photoPreview: null,

          async initApp() {
            try {
              await initDB(); // This calls initDB from static/app.js
              console.log("Alpine component initialized, DB connection ready via static/app.js.");
            } catch (error) {
              console.error("Alpine component: Failed to initialize DB via static/app.js:", error);
              alert("Database initialization failed. App may not function correctly.");
            }
          },

          handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (e) => {
                this.photoBase64 = e.target.result;
                this.photoPreview = e.target.result; 
              };
              reader.onerror = (e) => {
                console.error("FileReader error:", e);
                alert("Error reading file.");
                this.photoBase64 = null;
                this.photoPreview = null;
              };
              reader.readAsDataURL(file);
            } else {
              this.photoBase64 = null;
              this.photoPreview = null;
            }
          },

          async saveEntry() {
            if (!this.note && !this.photoBase64) {
              alert("Please enter a note or select a photo to save.");
              return;
            }

            const entryData = {
              timestamp: new Date().toISOString(),
              text: this.note,
              photo: this.photoBase64,
            };

            try {
              const newEntryId = await saveEntryToDB(entryData); // Calls saveEntryToDB from static/app.js
              console.log("Alpine component: Entry saved successfully with ID:", newEntryId);
              alert("Entry saved!");
              this.note = '';
              this.photoBase64 = null;
              this.photoPreview = null;
              // Reset file input
              const photoInput = document.getElementById('photo');
              if (photoInput) {
                photoInput.value = null;
              }
            } catch (error) {
              console.error("Alpine component: Error saving entry via static/app.js:", error);
              alert("Error saving entry. Check console for details.");
            }
          }
          // Functions to use readAllEntriesFromDB or markEntryAsSyncedInDB can be added here
          // when UI elements for those actions are implemented. For example:
          /*
          async loadAllEntries() {
            try {
              const entries = await readAllEntriesFromDB();
              // Process entries, e.g., display them
              console.log("Loaded entries:", entries);
            } catch (error) {
              console.error("Alpine: Error loading entries", error);
            }
          },
          async markEntrySynced(entryId) {
            try {
              await markEntryAsSyncedInDB(entryId);
              console.log(`Alpine: Marked entry ${entryId} as synced`);
              // Update UI accordingly
            } catch (error) {
              console.error(`Alpine: Error marking entry ${entryId} as synced`, error);
            }
          }
          */
        }
      }
